<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

   <!-- Website ownership verification script -->
   <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
     (function () {
         var script = document.createElement("script");
         script.async = 1;
         script.src = 'https://tp-em.com/NDg0Njc4.js?t=484678';
         document.head.appendChild(script);
     })();
   </script>
</head>
<body>
  <h1>Flight Search Demo</h1>
  <form id="flight-form">
    <label for="origin">From:</label>
    <input type="text" id="origin" name="origin" autocomplete="off" required placeholder="City or airport">
    <div id="origin-suggestions" class="suggestions"></div>
    <br>
    <label for="destination">To:</label>
    <input type="text" id="destination" name="destination" autocomplete="off" required placeholder="City or airport">
    <div id="destination-suggestions" class="suggestions"></div>
    <br>
    <label for="depart-date">Departure date:</label>
    <input type="date" id="depart-date" name="depart-date" required>
    <br>
    <label for="return-date">Return date:</label>
    <input type="date" id="return-date" name="return-date">
    <br>
    <button type="submit">Search Flights</button>
  </form>
  <h2>Available Flights</h2>
  <ul id="flights-list"></ul>

  <style>
    .suggestions { position: relative; }
    .suggestions-list {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      z-index: 10;
      max-height: 150px;
      overflow-y: auto;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .suggestions-list li {
      padding: 4px 8px;
      cursor: pointer;
    }
    .suggestions-list li:hover {
      background: #eee;
    }
  </style>
  <script>
    const API_KEY = 'd2e27a08557382081d80ed4268fbb552';
    // --- Autocomplete logic ---
    function setupAutocomplete(inputId, suggestionsId) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      let currentList = null;
      input.addEventListener('input', function() {
        const term = input.value.trim();
        if (term.length < 2) {
          if (currentList) currentList.remove();
          return;
        }
        fetch(`https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(term)}&locale=en&types[]=city&types[]=airport`)
          .then(r => r.json())
          .then(data => {
            if (currentList) currentList.remove();
            const ul = document.createElement('ul');
            ul.className = 'suggestions-list';
            data.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.name} (${item.code})`;
              li.dataset.code = item.code;
              li.dataset.name = item.name;
              li.addEventListener('mousedown', function(e) {
                input.value = `${item.name} (${item.code})`;
                input.dataset.code = item.code;
                ul.remove();
              });
              ul.appendChild(li);
            });
            if (data.length > 0) suggestionsDiv.appendChild(ul);
            currentList = ul;
          });
      });
      // Hide suggestions on blur
      input.addEventListener('blur', function() {
        setTimeout(() => { if (currentList) currentList.remove(); }, 100);
      });
    }
    setupAutocomplete('origin', 'origin-suggestions');
    setupAutocomplete('destination', 'destination-suggestions');

    // --- Flight search logic ---
    document.getElementById('flight-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const originInput = document.getElementById('origin');
      const destInput = document.getElementById('destination');
      const departDate = document.getElementById('depart-date').value;
      // Use only the IATA code (in parentheses)
      const originMatch = originInput.value.match(/\((\w{3})\)$/);
      const destMatch = destInput.value.match(/\((\w{3})\)$/);
      if (!originMatch || !destMatch) {
        alert('Please select valid cities/airports from the suggestions.');
        return;
      }
      const origin = originMatch[1];
      const destination = destMatch[1];
      // Fetch flights for the selected date
  fetch(`https://flightfinder-website.onrender.com/api/flights?origin=${origin}&destination=${destination}&depart_date=${departDate}`)
        .then(r => r.json())
        .then(data => {
          const flightsList = document.getElementById('flights-list');
          flightsList.innerHTML = '';
          // Helper sets to avoid repeated times
          const shownDepartures = new Set();
          const shownReturns = new Set();
          // Helper to format date/time
          function formatDT(dt) {
            return dt ? new Date(dt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit' }) : 'N/A';
          }
          // Helper to add flight info
          function addFlightInfo(type, time, from, to) {
            const key = `${type}-${time}-${from}-${to}`;
            if ((type === 'Departure' && shownDepartures.has(key)) || (type === 'Return' && shownReturns.has(key))) return;
            if (type === 'Departure') shownDepartures.add(key);
            if (type === 'Return') shownReturns.add(key);
            const li = document.createElement('li');
            li.textContent = `${type}: ${time} | From: ${from} | To: ${to}`;
            flightsList.appendChild(li);
          }
          let found = false;
          // Main data
          if (data.data && data.data.length > 0) {
            data.data.forEach(flight => {
              // Departure
              if (flight.departure_at) {
                addFlightInfo('Departure', formatDT(flight.departure_at), flight.origin || origin, flight.destination || destination);
                found = true;
              }
              // Return
              if (flight.return_at) {
                addFlightInfo('Return', formatDT(flight.return_at), flight.destination || destination, flight.origin || origin);
                found = true;
              }
            });
          }
          // Fallback: best_prices (older API format)
          if (!found && data.best_prices && data.best_prices.length > 0) {
            flightsList.innerHTML = '<li>No flights found for the selected date. Suggesting closest available flights:</li>';
            data.best_prices.sort((a, b) => Math.abs(new Date(a.departure_at) - new Date(departDate)) - Math.abs(new Date(b.departure_at) - new Date(departDate)));
            data.best_prices.slice(0, 3).forEach(flight => {
              if (flight.departure_at) {
                addFlightInfo('Departure', formatDT(flight.departure_at), flight.origin || origin, flight.destination || destination);
              }
              if (flight.return_at) {
                addFlightInfo('Return', formatDT(flight.return_at), flight.destination || destination, flight.origin || origin);
              }
            });
            found = true;
          }
          if (!found) {
            flightsList.innerHTML += '<li>No flights or alternative flights found.</li>';
          }
        })
        .catch(() => {
          document.getElementById('flights-list').innerHTML = '<li>Error fetching flights.</li>';
        });
    });
  </script>
</body>
</html>
