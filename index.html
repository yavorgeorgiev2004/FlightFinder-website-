<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>FlightFinder – Find Your Perfect Flight</title>
  <link rel="stylesheet" href="flightfinder-theme.css">

   <!-- Website ownership verification script -->
   <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
     (function () {
         var script = document.createElement("script");
         script.async = 1;
         script.src = 'https://tp-em.com/NDg0Njc4.js?t=484678';
         document.head.appendChild(script);
     })();
   </script>
</head>
<body>

  <header>
    <h1>Find Your Perfect Flight</h1>
    <p style="margin:0;font-size:1.1rem;opacity:0.85;">Search millions of flights and discover the best deals worldwide</p>
  </header>
  <main>
    <div id="user-greeting"></div>
    <div id="login-form-container">
      <form id="login-form">
        <label for="username">Enter your name:</label>
        <input type="text" id="username" name="username" required>
        <button type="submit">Login</button>
      </form>
    </div>
    <h2 style="margin-top:0.5rem;">Flight Search</h2>
    <form id="flight-form">
      <label for="origin">From</label>
      <input type="text" id="origin" name="origin" autocomplete="off" required placeholder="City or airport">
      <div id="origin-suggestions" class="suggestions"></div>
      <label for="destination">To</label>
      <input type="text" id="destination" name="destination" autocomplete="off" required placeholder="City or airport">
      <div id="destination-suggestions" class="suggestions"></div>
      <label for="depart-date">Departure date</label>
      <input type="date" id="depart-date" name="depart-date" required>
      <label for="return-date">Return date</label>
      <input type="date" id="return-date" name="return-date">
      <button type="submit">Search Flights</button>
    </form>
    <ul id="flights-list"></ul>
    <ul id="return-flights-list"></ul>
  </main>
  <footer>
    <div>© 2025 FlightFinder. All rights reserved. Powered by Travelpayouts API.</div>
  </footer>

  <!-- Styles moved to flightfinder-theme.css -->
  <script>
    // --- Login logic ---
    function showGreeting(name) {
      document.getElementById('user-greeting').textContent = `Welcome, ${name}!`;
    }
    function showLogin(show) {
      document.getElementById('login-form-container').style.display = show ? '' : 'none';
    }
    function checkLogin() {
      const name = localStorage.getItem('flight_username');
      if (name) {
        showGreeting(name);
        showLogin(false);
      } else {
        showGreeting('');
        showLogin(true);
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      checkLogin();
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('username').value.trim();
          if (name) {
            localStorage.setItem('flight_username', name);
            showGreeting(name);
            showLogin(false);
          }
        });
      }
    });
    const API_KEY = 'd2e27a08557382081d80ed4268fbb552';
    // --- Autocomplete logic ---
    function setupAutocomplete(inputId, suggestionsId) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      let currentList = null;
      input.addEventListener('input', function() {
        const term = input.value.trim();
        if (term.length < 2) {
          if (currentList) currentList.remove();
          return;
        }
        // Search for country, city, or airport
        fetch(`https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(term)}&locale=en&types[]=country&types[]=city&types[]=airport`)
          .then(r => r.json())
          .then(data => {
            if (currentList) currentList.remove();
            const ul = document.createElement('ul');
            ul.className = 'suggestions-list';
            data.forEach(item => {
              let label = item.name;
              if (item.type === 'airport') {
                label += ` (${item.code}) - ${item.city_name}, ${item.country_name}`;
              } else if (item.type === 'city') {
                label += ` (${item.code}) - ${item.country_name}`;
              } else if (item.type === 'country') {
                label += ` (${item.code})`;
              }
              const li = document.createElement('li');
              li.textContent = label;
              li.dataset.code = item.code;
              li.dataset.name = item.name;
              li.dataset.type = item.type;
              li.addEventListener('mousedown', function(e) {
                input.value = label;
                input.dataset.code = item.code;
                input.dataset.type = item.type;
                ul.remove();
              });
              ul.appendChild(li);
            });
            if (data.length > 0) suggestionsDiv.appendChild(ul);
            currentList = ul;
          });
      });
      // Hide suggestions on blur
      input.addEventListener('blur', function() {
        setTimeout(() => { if (currentList) currentList.remove(); }, 100);
      });
    }
    setupAutocomplete('origin', 'origin-suggestions');
    setupAutocomplete('destination', 'destination-suggestions');

    // --- Flight search logic ---
    document.getElementById('flight-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const originInput = document.getElementById('origin');
      const destInput = document.getElementById('destination');
      const departDate = document.getElementById('depart-date').value;
      const returnDate = document.getElementById('return-date').value;
      const originCode = originInput.dataset.code;
      const destCode = destInput.dataset.code;
      if (!originCode || !destCode) {
        alert('Please select valid airports or cities from the suggestions.');
        return;
      }
      const flightsList = document.getElementById('flights-list');
      const returnFlightsList = document.getElementById('return-flights-list');
      flightsList.innerHTML = '';
      returnFlightsList.innerHTML = '';

      // Helper to format date
      function formatDate(dt) {
        return dt ? new Date(dt).toLocaleDateString('en-GB') : 'N/A';
      }

      // Helper to add flight info
      function addFlightInfo(type, flight, listElem) {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${type}</strong><br>
          <strong>From:</strong> ${flight.origin} <strong>To:</strong> ${flight.destination}<br>
          <strong>Departure:</strong> ${formatDate(flight.departure_at)}<br>
          <strong>Price:</strong> ${flight.value} ${flight.currency}<br>
          <strong>Airline:</strong> ${flight.airline || 'N/A'}<br>
          <strong>Flight #:</strong> ${flight.flight_number || 'N/A'}<br>
          <strong>Booking:</strong> ${flight.link ? `<a href='${flight.link}' target='_blank'>Book</a>` : 'N/A'}
        `;
        listElem.appendChild(li);
      }

      // Fetch and display flights from Travelpayouts API
      function fetchFlights(from, to, date, typeLabel, listElem) {
  const url = `https://flightfinder-website.onrender.com/api/travelpayouts/flights?origin=${from}&destination=${to}&departure_at=${date}`;
  fetch(url)
    .then(async r => {
      if (!r.ok) {
        const text = await r.text();
        throw new Error(`HTTP ${r.status}: ${text}`);
      }
      return r.json();
    })
    .then(data => {
      if (data.error) {
        listElem.innerHTML = `<li>API Error: ${data.error}</li>`;
        console.error('API Error:', data);
        return;
      }
      if (data.data && Array.isArray(data.data) && data.data.length > 0) {
        // Sort by proximity to selected date
        const sorted = data.data.slice().sort((a, b) => {
          const dA = Math.abs(new Date(a.departure_at) - new Date(date));
          const dB = Math.abs(new Date(b.departure_at) - new Date(date));
          return dA - dB;
        });
        sorted.slice(0, 5).forEach(flight => addFlightInfo(typeLabel, flight, listElem));
      } else {
        listElem.innerHTML = `<li>No ${typeLabel.toLowerCase()} flights found.</li>`;
        console.warn('No flights found:', data);
      }
    })
    .catch(err => {
      listElem.innerHTML = `<li>Error fetching ${typeLabel.toLowerCase()} flights.<br><span style='color:red;'>${err.message}</span></li>`;
      console.error('Fetch error:', err);
    });
      }

      // Outbound flights
      fetchFlights(originCode, destCode, departDate, 'Departure', flightsList);
      // Always show return flights section
      returnFlightsList.innerHTML = '<strong>Return Flights</strong>';
      if (returnDate) {
        fetchFlights(destCode, originCode, returnDate, 'Return', returnFlightsList);
      } else {
        returnFlightsList.innerHTML += '<li>No return date selected.</li>';
      }
    });
  </script>
</body>
</html>
