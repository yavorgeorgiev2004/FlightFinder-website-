<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

   <!-- Website ownership verification script -->
   <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
     (function () {
         var script = document.createElement("script");
         script.async = 1;
         script.src = 'https://tp-em.com/NDg0Njc4.js?t=484678';
         document.head.appendChild(script);
     })();
   </script>
</head>
<body>
  <h1>Flight Search Demo</h1>
  <form id="flight-form">
    <label for="origin">From:</label>
    <input type="text" id="origin" name="origin" autocomplete="off" required placeholder="City or airport">
  <div id="origin-suggestions" class="suggestions"></div>
    <br>
    <label for="destination">To:</label>
    <input type="text" id="destination" name="destination" autocomplete="off" required placeholder="City or airport">
  <div id="destination-suggestions" class="suggestions"></div>
    <br>
    <label for="depart-date">Departure date:</label>
    <input type="date" id="depart-date" name="depart-date" required>
    <br>
    <label for="return-date">Return date:</label>
    <input type="date" id="return-date" name="return-date">
    <br>
    <button type="submit">Search Flights</button>
  </form>
  <h2>Available Flights</h2>
  <ul id="flights-list"></ul>

  <style>
    .suggestions { position: relative; }
    .suggestions-list {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      z-index: 10;
      max-height: 150px;
      overflow-y: auto;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .suggestions-list li {
      padding: 4px 8px;
      cursor: pointer;
    }
    .suggestions-list li:hover {
      background: #eee;
    }
  </style>
  <script>
    const API_KEY = 'd2e27a08557382081d80ed4268fbb552';
    // --- Autocomplete logic ---
    function setupAutocomplete(inputId, suggestionsId) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      let currentList = null;
      input.addEventListener('input', function() {
        const term = input.value.trim();
        if (term.length < 2) {
          if (currentList) currentList.remove();
          return;
        }
        // Search for country, city, or airport
        fetch(`https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(term)}&locale=en&types[]=country&types[]=city&types[]=airport`)
          .then(r => r.json())
          .then(data => {
            if (currentList) currentList.remove();
            const ul = document.createElement('ul');
            ul.className = 'suggestions-list';
            data.forEach(item => {
              let label = item.name;
              if (item.type === 'airport') {
                label += ` (${item.code}) - ${item.city_name}, ${item.country_name}`;
              } else if (item.type === 'city') {
                label += ` (${item.code}) - ${item.country_name}`;
              } else if (item.type === 'country') {
                label += ` (${item.code})`;
              }
              const li = document.createElement('li');
              li.textContent = label;
              li.dataset.code = item.code;
              li.dataset.name = item.name;
              li.dataset.type = item.type;
              li.addEventListener('mousedown', function(e) {
                input.value = label;
                input.dataset.code = item.code;
                input.dataset.type = item.type;
                ul.remove();
              });
              ul.appendChild(li);
            });
            if (data.length > 0) suggestionsDiv.appendChild(ul);
            currentList = ul;
          });
      });
      // Hide suggestions on blur
      input.addEventListener('blur', function() {
        setTimeout(() => { if (currentList) currentList.remove(); }, 100);
      });
    }
    setupAutocomplete('origin', 'origin-suggestions');
    setupAutocomplete('destination', 'destination-suggestions');

    // --- Flight search logic ---
    document.getElementById('flight-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const originInput = document.getElementById('origin');
      const destInput = document.getElementById('destination');
      const departDate = document.getElementById('depart-date').value;
      const returnDate = document.getElementById('return-date').value;
      // Use the selected code and type for more accurate search
      const originCode = originInput.dataset.code;
      const originType = originInput.dataset.type;
      const destCode = destInput.dataset.code;
      const destType = destInput.dataset.type;
      if (!originCode || !destCode) {
        alert('Please select valid countries, cities, or airports from the suggestions.');
        return;
      }
      // Helper sets to avoid repeated times
      const shownDepartures = new Set();
      const shownReturns = new Set();
      // Helper to format date/time
      function formatDT(dt) {
        return dt ? new Date(dt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit' }) : 'N/A';
      }
      // Helper to add flight info
      function addFlightInfo(type, time, from, to, listElem) {
  const key = `${type}-${time}-${from}-${to}`;
  if ((type === 'Departure' && shownDepartures.has(key)) || (type === 'Return' && shownReturns.has(key))) return;
  if (type === 'Departure') shownDepartures.add(key);
  if (type === 'Return') shownReturns.add(key);
  const li = document.createElement('li');
  li.textContent = `${type}: ${time} | From: ${from} | To: ${to}`;
  listElem.appendChild(li);
      }
      // Helper to filter by max days difference
      function withinDays(dateStr, refStr, maxDays) {
        const d1 = new Date(dateStr);
        const d2 = new Date(refStr);
        return Math.abs((d1 - d2) / (1000 * 60 * 60 * 24)) <= maxDays;
      }
      // Fetch and display flights (direction: 'outbound' or 'return')
      function fetchAndDisplayFlights(from, to, date, typeLabel, listElem) {
        let apiUrl = `https://flightfinder-website.onrender.com/api/flights?origin=${from}&destination=${to}&depart_date=${date}`;
        fetch(apiUrl)
          .then(r => r.json())
          .then(data => {
            let found = false;
            let flights = [];
            if (data.data && data.data.length > 0) {
              flights = data.data.filter(flight => flight.departure_at && withinDays(flight.departure_at, date, 3));
              flights.sort((a, b) => Math.abs(new Date(a.departure_at) - new Date(date)) - Math.abs(new Date(b.departure_at) - new Date(date)));
              flights.forEach(flight => {
                // Show specific airport codes if available
                const fromCode = flight.origin_airport || flight.origin || from;
                const toCode = flight.destination_airport || flight.destination || to;
                addFlightInfo(typeLabel, formatDT(flight.departure_at), fromCode, toCode, listElem);
                found = true;
              });
            }
            // Fallback: best_prices (older API format)
            if (!found && data.best_prices && data.best_prices.length > 0) {
              listElem.innerHTML += '<li>No flights found for the selected date. Suggesting closest available flights:</li>';
              let bests = data.best_prices.filter(flight => flight.departure_at && withinDays(flight.departure_at, date, 3));
              bests.sort((a, b) => Math.abs(new Date(a.departure_at) - new Date(date)) - Math.abs(new Date(b.departure_at) - new Date(date)));
              bests.slice(0, 3).forEach(flight => {
                const fromCode = flight.origin_airport || flight.origin || from;
                const toCode = flight.destination_airport || flight.destination || to;
                addFlightInfo(typeLabel, formatDT(flight.departure_at), fromCode, toCode, listElem);
                found = true;
              });
            }
            if (!found) {
              listElem.innerHTML += `<li>No ${typeLabel.toLowerCase()} flights or alternative flights found.</li>`;
            }
          })
          .catch(() => {
            listElem.innerHTML = `<li>Error fetching ${typeLabel.toLowerCase()} flights.</li>`;
          });
      }
      // Main logic
      const flightsList = document.getElementById('flights-list');
      flightsList.innerHTML = '';
      // Outbound flights
      fetchAndDisplayFlights(originCode, destCode, departDate, 'Departure', flightsList);
      // Return flights (if return date is selected)
      if (returnDate) {
        fetchAndDisplayFlights(destCode, originCode, returnDate, 'Return', flightsList);
      }
    });
  </script>
</body>
</html>
